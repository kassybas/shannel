
var gcp_project: kassybas
var : ""

struct ClusterConfig:
	name: ~
	location: ~
	configPath: ~

src clusterConfLine:
  sh: gcloud container clusters list --project="${gcpProject}" | grep "${clusterFilter}" | snl push -d "\n"

channel clusterConfLine -> clusters<ClusterConfig>:
	sh: | 
    name="$(cut -d' ' -f1 <<< ${clusterConfLine})"
    path="config-sync/cluster-sync-configs/${name}"
    location="$(cut -d' ' -f2 <<< ${clusterConfLine})"
    if [[ ! -f ${path} ]]; then
      echo "SKIP: no config found for cluster ${name}"
      exit 0
    fi
    snl push .name=${name} .location=${location} .configPath=${path}

sync clusters -> authedCluster:
  - clusters -> gcpClusterAuth
	- clusters -> checkClusterMembership, checkContext
	- ensureNamespace
	- ensureGitCreds
	- applyConfigManagement
	- printClusterStatus

sync channel clusters -> authedCluster:
  sh: |
    gcloud container clusters get-credentials "${cluster_name}" \
    --region "${cluster_location}" \
    --project=${gcpProject} 

sync authedCluster -> memberCluster:
  local:
    errorMsg: |
      Cluster not registered in Container Hub
      please register it via Config Connnect (./project/containerhub-membership)
      see: https://cloud.google.com/anthos/multicluster-management/connect/registering-a-cluster#config-connector
  sh: gcloud container hub memberships list --project=${gcpProject} | grep "${clusterToCheck}" || snl push --status fatalLog "${errorMsg}"


sync authedCluster -> contextCluster:
